;; korns_regression_p12.clj
;; a symbolic regression problem based on Michael Korns's draft chapter from GPTP11
;; Lee Spector, lspector@hampshire.edu, 2011

(ns examples.korns-regression-p12 
  (:require [clojush] [clojure.contrib.math])
  (:use [clojush] [clojure.contrib.math]))

(defn generate-data 
  [rows] ;; korns uses 10000! But we won't :-)
  ;; There are five columns of data, only two of which are actually used in the
  ;; target formula. We also compute the answers here and store them as the 
  ;; sixth column.
  (println "(def data '(")
  (doall
    (repeatedly rows
      (fn []
        (let [inputs (repeatedly 5 #(- (* (rand) 100) 50))]
          (println (concat inputs (list (- 2.0 (* 2.1 
                                                 (Math/cos (* 9.8 (nth inputs 0)))
                                                 (Math/sin (* 1.3 (nth inputs 4))))))))))))
  (println "))"))

;(generate-data 100)
 
(def data '(
(-31.73117325008007 17.773604522468673 31.925706547733043 36.416289048313004 32.49069406728982 -0.06562138816756669)
(-28.787483635591528 28.726707225743425 26.12958469185277 30.40946153838358 -31.931077640882854 0.943614754386817)
(-39.8366746305788 5.898328014623608 -40.63986958492947 31.715529833544238 49.81749645034415 0.6910427652174165)
(-47.85199599535973 1.5436755717853856 -31.987984681023818 -12.861725463664321 -23.763577863688255 2.690814122278602)
(31.23869963297487 3.076901113909379 -41.7700962255994 -6.661334311364364 -37.998896867086565 2.2645749940307467)
(-10.811510860782079 40.591805938102084 23.329861676334474 -32.063106871301244 15.561069731693678 0.65688802838761)
(-9.524262005642484 16.320108256485682 3.0746105623062903 -45.409712094312326 -44.47087080936873 3.2284561595629473)
(-34.09380385749223 -14.069755794726078 46.13418939708963 -47.477410187487415 -28.260187644827095 1.2352872079989745)
(12.548972844317007 -27.505882238082247 -39.7865253711626 39.67216113110828 10.624427371566156 3.784877923163209)
(4.982329186256621 -9.223715545260802 -37.48001539763136 49.73757242334294 9.310806815306684 2.1234099317121493)
(19.73459475194936 7.408242619438624 -21.67624918529999 -18.491582013234776 -26.041883289225375 2.2578697920083077)
(46.67976828950174 -33.33219404500897 48.67125532683204 0.042377625859188583 8.522437891953501 2.73718893044257)
(-2.956380107975164 9.57358573409659 -38.7325227322696 -9.250500818008419 -42.94420731772254 3.0621431461530664)
(9.014572528665418 40.33615969274575 -23.42110068305584 -39.69236519061404 36.74851063581666 3.1797871603104886)
(-42.77948167696951 14.79260713822994 39.711000851232086 16.944038509838407 46.700377964804616 1.7083381050035313)
(-21.682973136099083 33.06992642034811 7.340398343851753 -21.444543828436803 -4.949160852768266 2.133061228955215)
(8.011447695825503 -41.38349534933654 44.87719599097984 -47.32330665662276 -46.09664468482633 2.489554634849486)
(-6.038780592178952 -16.404843481921738 15.22837097892615 2.0900737603696484 -43.56911628795428 1.8331335269807465)
(-44.93330485524494 -46.65482503500237 22.59422656297673 37.402845125955295 39.45761138548599 0.4412564284285858)
(-17.569529618978883 -14.62708047783822 43.28132443393797 -23.354691909791146 23.34144809863274 0.48442538212410424)
(-32.71591060349893 -20.415323910939232 27.50496007561233 48.772334895767244 32.10974755083211 3.622823674824528)
(31.640707592971722 -4.306937122408115 -44.846538657770786 10.299318161368795 -0.6605882703033643 1.0607502344354705)
(12.421638466150917 4.6737024105030684 -42.462301320912196 -0.259902138406062 -46.77969068977548 3.3324819177886975)
(14.944010253704661 -23.190967356623528 -14.19741577071106 25.31231729600448 34.854894023152355 2.732067600234752)
(47.31865745881005 42.10975787136164 36.98451913077213 34.34084247684717 15.452030998885888 1.341963782068663)
(9.171470077620484 36.210236819556656 -46.95011042827024 -32.109100269022136 -43.25262404094048 2.223592227192059)
(-15.212186957754689 -1.6733860868933448 25.073332889963396 -26.4009802262446 16.386570914918124 2.1944300826525933)
(-43.547924707542094 -35.62431210237973 -33.82091058862328 12.145815797537118 -17.255677075840026 1.2074247497051673)
(6.7109665612377825 -38.01158476245272 15.851431751978879 -34.09173231915764 -22.32058868881318 3.3897604176185534)
(-5.321013275695442 2.218472256276783 19.93385439300772 -15.026367522140504 7.45387977457024 1.8322333949636698)
(6.437156300948658 42.876674626991544 37.431921723318666 48.912650576423644 20.8934576803087 0.1760129327420361)
(-3.984756507851003 -32.050145835268886 -48.7865984273717 -34.145497076446915 -0.8356147664592157 2.404258445775438)
(12.401660463352059 -25.729572732583595 44.91280697093738 8.334299182231419 39.789252591682526 3.1525005153928407)
(-28.32107222760132 3.112350898793636 40.460023310435545 25.028231013826783 -15.844003013039519 2.962746357382205)
(15.933359611402338 36.58620548536061 5.0965569799345545 -5.490274891906807 -49.30843087660024 3.1943921115957084)
(9.677199913358649 -38.28698262137815 -15.504099882041508 -41.58830655350256 6.13271894978309 0.26585823974076717)
(29.27899508004724 18.39448129702909 -26.136344965479687 21.12437235290831 35.5084847746555 2.858848328906249)
(40.73563640756922 24.20412990669554 47.02861089750719 43.987667601057765 16.327806666148135 3.4170280480017734)
(-27.45523247352708 1.5167606875308834 -17.153198959267243 -40.41204280773335 -48.227545248571346 1.8748084441065276)
(-22.727056185688465 11.793558036642949 -2.8532711791729426 -23.924201132475943 -21.154095459600676 0.6103052458683655)
(0.9483728261683524 -17.20100939280804 -47.11401016199339 -36.199164310887845 -30.761239038672482 0.43427037007045177)
(37.092833138495536 -43.680922648978004 -14.877458199378324 -42.44905536147701 15.197790908760496 0.9908817396184979)
(-35.28940631934272 39.7313396600988 -7.596396860627117 16.165657538624046 9.462368783655108 2.5319535408899023)
(-35.991628067597034 29.599880890112857 34.29498983874984 30.175301557035297 -18.61297800590407 0.8963557037925007)
(-45.86974830476127 19.03298462584317 -18.079241140597134 -0.6476078419326186 -47.459750034634084 3.831082239781523)
(-46.30387448738807 -5.492869972440019 -26.39907538385444 -32.95657368121873 -14.736383439043486 2.1152387570492537)
(40.727067385616934 5.6473655132738045 -13.14864645451501 37.59529025239007 30.824742468826543 3.444782546575399)
(16.826490000361034 31.50888500494476 18.648319715034717 13.801423348457106 46.42211127550566 2.043698388012036)
(33.46428817499434 -11.385248921919619 32.68157871754728 -45.43390782926045 32.670251872336024 2.711719650923245)
(-9.62550310579583 -49.50941005569928 -28.414807589612423 -45.29678267564137 -43.74389246316165 2.6551674018928972)
(36.44907017540285 24.633794091292017 -44.295145674735494 -4.179729534972175 -22.2322755562952 1.2733636447868766)
(-10.264353421515814 -17.609077693200348 38.228678581830806 -38.56944684298465 -37.2320300212287 -0.006891491650100612)
(13.439170141134305 49.73354683407872 -47.51687300318931 16.45639569683641 19.759308068325282 0.9270464784085657)
(-28.0793116044593 -19.403449739803136 12.109386740325675 5.464531631202874 29.561755297358232 1.601849027848285)
(35.056675912757356 -35.39407826169614 -31.19455065456842 38.27891232194439 -40.16801588808858 1.1542644789287044)
(17.060406166158444 -47.106316268697455 1.6978011657794028 35.002501286819125 -32.37610929837358 3.539165279712792)
(39.73382862257645 25.36239527067835 28.585992524046105 5.040907294926512 -22.101154594286054 1.0857809136093335)
(-9.592058171413441 3.676592272659839 -48.133715131874496 24.125375970801727 23.83585979918935 2.8478764626257003)
(-30.18503768844868 -15.343435495072697 22.17188686700655 -25.792854222500917 -25.36208851989733 3.838990626724212)
(-1.0142754671000205 38.47393612257028 -48.331562157331234 42.10939641780767 13.79510533572251 0.5505771683143119)
(23.447256348816254 19.44760525548962 -22.986338123082106 -35.6274211854857 -30.269195098308955 0.11225565524644598)
(30.303355963752196 -28.104770635394672 16.16616943714486 -5.771736281031238 -14.114003919402776 2.0931076225637755)
(-27.740673386314462 42.67247148016999 -20.502061243284707 -40.4358105346665 -21.399741429284646 1.8979920748819556)
(49.80039041516248 -28.142622233281543 -36.004867788114105 -10.295872104706973 -3.604144848894272 2.957878743308939)
(48.51046536057386 -36.43668550658373 20.676259617781525 -43.976650461305 34.07111837447964 2.3343132301831915)
(28.785615313471595 -38.72751864030035 -11.364766251814643 -31.950857016736055 4.8781757085261575 1.9019309237495656)
(-24.6325343265013 42.419988059127306 -0.8197839459610492 19.903141039831098 -19.227877365092006 2.250257648386676)
(-14.094315064264919 9.923354132045922 -10.738985701173675 -9.884009673322616 -21.694867677978557 2.1481542179246658)
(-44.98437621708392 -17.232960798483695 38.139504141458175 22.124291480853515 31.665302772642647 2.3478630537027114)
(8.147652306775612 -31.50515650321988 6.2157459899207765 -14.218966495705907 30.51572667082239 2.5039014369139654)
(4.033087402378868 39.744119130153024 -1.4239971389244346 -8.769007801425147 -21.440828918464717 1.793623573143703)
(-2.0594625212851128 -9.047497657245962 11.524641990894871 -34.834824133431574 49.058358116794224 1.5996425617816006)
(29.263705892946717 -33.635177567165364 -3.4936878741403135 8.60254363198191 15.36583717394491 3.179294504682338)
(-7.737661687350048 35.762866568882885 -28.309745276098475 -3.6846202132833312 49.063581252187234 0.44705297144528267)
(23.53533770330813 7.310316990718405 34.63232546408814 -9.74967924067166 -4.451184448206405 2.2579620140067393)
(-40.715534336559266 38.74188010226503 8.863685100495246 38.7966675284554 -12.106655611603578 2.064407905793022)
(-34.976508435171674 16.89227429567663 29.632375255323993 3.4154415800789337 -32.162591225051806 3.6360329543491288)
(-15.187941756839265 -23.67759609548702 -11.762689927345512 -8.03456267793512 14.938303219305126 2.4245139016814203)
(-29.298225786787846 -22.271510424556872 -26.906072556526983 47.34748861963848 38.82800212138592 2.143762365884124)
(-28.265144329521895 36.28346034037942 0.3497978038359193 -31.092066230146408 -21.670888623457085 2.183914184536481)
(-40.18889211418577 28.84042191874137 -13.724100227863467 49.36742114091237 2.337512486984096 2.0876458812206646)
(43.330578268654236 39.83057054928729 -46.56372774081958 -24.957518573912463 -29.943166938055366 0.2888165654112227)
(-37.908261740836366 45.93383318826521 -22.810826649645954 48.28989360691594 -34.08280049265315 2.470995651645983)
(38.31521150621555 3.5183720617807595 -45.188203228968185 44.9238041734705 38.94123049525042 1.9494342764030552)
(-25.05926970526665 17.502966424817487 -48.21435318983717 36.50539810250382 40.18628933035785 0.3418139139129952)
(30.078377778837677 38.836285820369 23.67399001385472 45.38700778818141 8.234635246749 3.7240300681921537)
(-41.2192597307398 13.35929981584546 -28.990644021116562 33.81746608472096 39.827025474115345 2.526878183198779)
(-17.043776443189543 -8.879430317154494 18.091793634975673 -30.824254401756257 -7.092434359527346 1.6306839643842008)
(18.66342484899907 -22.205811010606524 41.56032761709642 -34.87645456469682 -37.769091932137854 0.5104965143836813)
(-41.62981869624186 -44.59077260281372 -25.933769107172978 34.77350548944035 -42.35348139478427 0.10176101382329739)
(-31.794496998996312 -1.2803501615850337 22.738253549443883 0.16120645998971384 -45.25208271418427 0.6558227705931525)
(7.201617206785862 45.330113930232855 -12.528300128937033 47.27173635276199 -2.5666020451249665 1.955338032441037)
(7.902627284076779 2.984397018570384 -25.233752024951894 -2.9315087304523786 -19.073806302095697 2.3184448160148343)
(-18.80386956614104 -39.67007149461402 33.79199600092778 16.54877781502377 -39.2888959547591 1.2777514397196823)
(-19.966853126166573 23.137167211322335 48.455198409051036 27.994304759894376 34.51210897217 0.986482978899299)
(-14.87409321458101 7.547585040098092 24.545106484103243 35.396747275803676 -6.674863393395157 2.4462665463531392)
(25.91099966781543 34.022466504014005 -37.320911629164115 -19.678894966824977 -5.405392111485163 0.7812866365484543)
(-12.174297475410576 6.257611467747715 -27.85113295824887 -13.069785670097353 27.73257330415116 4.088456444860952)
(-34.85307787087167 0.874325803298035 -41.57363973004124 42.41896125202112 41.2211036878348 1.7580812583172118)
(49.31138524413225 -13.28240227764207 -48.96778867622914 30.862851153191855 14.766900577232818 1.391843599099651)
))


(define-registered x0 
  (fn [state] (push-item (stack-ref :auxiliary 0 state) :float state)))

(define-registered x1 
  (fn [state] (push-item (stack-ref :auxiliary 1 state) :float state)))

(define-registered x2 
  (fn [state] (push-item (stack-ref :auxiliary 2 state) :float state)))

(define-registered x3 
  (fn [state] (push-item (stack-ref :auxiliary 3 state) :float state)))

(define-registered x4 
  (fn [state] (push-item (stack-ref :auxiliary 4 state) :float state)))

(pushgp 
  :error-function (fn [program]
                    (doall
                      (for [row data]
                        (let [state (run-push program 
                                      (assoc (make-push-state)
                                        :auxiliary
                                        (take 5 row)))
                              top-float (top-item :float state)]
                          (if (number? top-float)
                            (expt (- top-float (nth row 5)) 2)
                            1000)))))
	 :atom-generators (list 
                     (fn [] (- (* (rand) 100) 50))
                     (fn [] (- (rand) 0.5))
                     'x0
                     ;'x1
                     ;'x2
                     ;'x3
                     'x4
                     'float_div
                     'float_mult
                     'float_add
                     'float_sub
                     'float_sin
                     'float_cos
                     ;'float_tan
                     )
   :max-points 200
   :evalpush-limit 1000
   :population-size 500
   :mutation-probability 0.20
   :mutation-max-points 20
   :crossover-probability 0.40
   :simplification-probability 0.1
   :reproduction-simplifications 10
   :gaussian-mutation-probability 0.2
   :gaussian-mutation-per-number-mutation-probability 0.5
   :gaussian-mutation-standard-deviation 0.1
   :tournament-size 1
   :decimation-ratio 0.1
   :decimation-tournament-size 2
   :node-selection-method :size-tournament
   :node-selection-tournament-size 3
   :max-generations 10000)
